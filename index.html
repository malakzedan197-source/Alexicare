<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لعبة المشاعر - باتمان الدليل الصوتي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Changa:wght@400;600;800&display=swap');

        body {
            font-family: 'Changa', sans-serif;
            background: linear-gradient(135deg, #fef3c7 0%, #ffc0cb 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
            position: relative;
        }

        .star-bg {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .star {
            position: absolute;
            background: #fff9e0;
            border-radius: 50%;
            opacity: 0.8;
            animation: twinkle 5s infinite ease-in-out;
        }

        .star:nth-child(1) {
            top: 10%;
            left: 5%;
            width: 15px;
            height: 15px;
            animation-delay: 0s;
        }

        .star:nth-child(2) {
            top: 20%;
            right: 10%;
            width: 10px;
            height: 10px;
            animation-delay: 1.5s;
        }

        .star:nth-child(3) {
            bottom: 5%;
            left: 15%;
            width: 8px;
            height: 8px;
            animation-delay: 3s;
        }

        .star:nth-child(4) {
            bottom: 25%;
            right: 5%;
            width: 12px;
            height: 12px;
            animation-delay: 0.5s;
        }

        .star:nth-child(5) {
            top: 40%;
            left: 30%;
            width: 18px;
            height: 18px;
            animation-delay: 2.2s;
        }

        .star:nth-child(6) {
            top: 60%;
            right: 20%;
            width: 9px;
            height: 9px;
            animation-delay: 4s;
        }

        @keyframes twinkle {
            0%, 100% {
                transform: scale(0.5);
                opacity: 0.5;
            }
            50% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .screen-container {
            transition: opacity 0.5s ease-in-out, transform 0.5s;
            max-width: 480px;
            width: 100%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .emotion-button {
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        .emotion-button:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        .avatar-image-container {
            width: 80px;
            height: 80px;
            overflow: hidden;
            border-radius: 50%;
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .avatar-image-container img {
            width: 100%;
            height: 100%;
            object-fit: fill;
        }

        @keyframes shake {
            0%, 100% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(-5px);
            }
            50% {
                transform: translateX(5px);
            }
            75% {
                transform: translateX(-5px);
            }
        }

        .animate-shake {
            animation: shake 0.5s infinite;
        }

        #tts-control {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            background: #4f46e5;
            color: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s;
        }

        #tts-control:hover {
            transform: scale(1.1);
            background: #4338ca;
        }

        #tts-control.muted {
            background: #6b7280;
        }

        #tts-control i {
            font-size: 24px;
        }
        
        .recording {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <!-- TTS Control Button -->
    <div id="tts-control" title="تشغيل/إيقاف الصوت">
        <i class="fas fa-volume-up"></i>
    </div>

    <div class="star-bg">
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
    </div>

    <div id="batman-guide"
        class="fixed top-4 right-4 z-50 flex items-center space-x-2 space-x-reverse bg-yellow-400 p-2 rounded-xl shadow-2xl border-4 border-yellow-600 transition duration-500"
        style="display: none;">
        <div class="w-12 h-12 flex-shrink-0 text-gray-800 animate-bounce">
            <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="w-full h-full">
                <path
                    d="M12 1.5C6.201 1.5 1.5 6.201 1.5 12c0 5.093 3.66 9.38 8.5 10.383V16.5H7.5V14h2.5V12c0-2 1.5-3.5 3.5-3.5s3.5 1.5 3.5 3.5v2h-2.5v2.5h2.5V21.5c4.787-1.12 8.5-5.32 8.5-10.233C22.5 6.201 17.799 1.5 12 1.5zm-3 10.5h6v1h-6v-1z"
                    fill="#000000" />
            </svg>
        </div>
        <div
            class="bg-white p-2 rounded-lg relative before:content-[''] before:absolute before:border-8 before:border-transparent before:border-r-white before:-right-4 before:top-1/2 before:-translate-y-1/2">
            <p id="guide-instruction" class="text-gray-800 text-sm font-semibold whitespace-nowrap">مرحباً بك في لعبة المشاعر!</p>
        </div>
    </div>

    <div id="app-container" class="w-full max-w-lg mx-auto">

        <script>
            // --- Global Variables and Constants ---
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            let userName = '';
            let userGender = '';
            let userAvatar = null;
            let currentEmotion = null;
            let audioInitialized = false;
            let isRecordingName = false;
            let nameRecognition = null;
            let ttsEnabled = true;
            let ttsSupported = true;
            let speechRecognitionSupported = true;

            const instructions = {
                'welcome-screen': 'مرحباً يا بطل! أنا باتمان، صديقك الخارق. أدخل اسمك لتنطلق معنا في المغامرة!',
                'avatar-screen': 'هيا، اختر البطل الذي يمثلك! اضغط على الشخصية التي تحبها، ثم اضغط على زر "هذه شخصيتي!".',
                'checkin-screen': 'أهلاً بك! قبل أن نبدأ اللعب، اختر الوجوه المعبرة عن شعورك الآن. فقط اضغط على وجه واحد.',
                'main-menu': 'أنت مستعد للعب يا صديقي! اختر مستوى لتبدأ التعلم والمغامرات، أو اضغط على لوحة الإنجاز.',
                'learning-screen': 'اسمع جيداً عن هذا الشعور! اضغط على أيقونة المشاعر لتتحدث عن نفسها، ثم اضغط على زر "التالي".',
                'face-detection-screen': 'انظر إلى الكاميرا وحاول أن تصنع وجهاً سعيداً! كن بطلاً في التعبير!',
                'challenge-screen': 'حان وقت التحدي! اقرأ السؤال واضغط على الإجابة الصحيحة لتكسب النقاط.',
                'leaderboard-screen': 'هنا ترى ترتيبك بين الأبطال! كم نجمة ستحصل اليوم؟ عد إلى القائمة للمتابعة.'
            };

            // --- Avatar Data for Dynamic Loading ---
            const avatars = {
                boy: [
                    { id: 1, name: 'باتمان', imagePath: 'batman.jpg', color: 'bg-black', border: 'border-yellow-500' },
                    { id: 2, name: 'سبايدرمان', imagePath: 'spiderman.jpg', color: 'bg-red-800', border: 'border-blue-500' },
                    { id: 3, name: 'سوبرمان', imagePath: 'super.jpg', color: 'bg-blue-800', border: 'border-red-500' },
                    { id: 4, name: 'ميكي ماوس', imagePath: 'mickey mouse.jpg', color: 'bg-black', border: 'border-gray-500' },
                    { id: 5, name: 'وودي', imagePath: 'woody.jpg', color: 'bg-orange-800', border: 'border-yellow-600' },
                    { id: 6, name: 'سبونج بوب', imagePath: 'sponge pop.jpg', color: 'bg-yellow-400', border: 'border-orange-500' }
                ],
                girl: [
                    { id: 7, name: 'باربي', imagePath: 'barbie.jpg', color: 'bg-pink-500', border: 'border-pink-500' },
                    { id: 8, name: 'ميني ماوس', imagePath: 'minimouse.jpg', color: 'bg-black', border: 'border-gray-500' },
                    { id: 9, name: 'إلسا', imagePath: 'elsa.jpg', color: 'bg-blue-300', border: 'border-blue-500' },
                    { id: 10, name: 'موانا', imagePath: 'moana.jpg', color: 'bg-teal-500', border: 'border-red-300' },
                    { id: 11, name: 'رابونزل', imagePath: 'tangled.jpg', color: 'bg-purple-300', border: 'border-purple-500' },
                    { id: 12, name: 'سبونج بوب', imagePath: 'sponge pop.jpg', color: 'bg-yellow-400', border: 'border-orange-500' }
                ]
            };

            // Function to generate the HTML grid for avatars
            function generateAvatarGrid(gender) {
                const avatarList = avatars[gender] || avatars.boy;
                let html = '';

                avatarList.forEach(avatar => {
                    const cardClass = `p-4 rounded-2xl cursor-pointer text-center shadow-md transition duration-300 bg-gray-100 text-gray-800`;

                    const contentHtml = `
                        <div class="avatar-image-container border-4 ${avatar.border}">
                            <img src="${avatar.imagePath}" alt="${avatar.name}">
                        </div>
                    `;

                    html += `
                        <div id="avatar-${avatar.id}" onclick="selectAvatar(${avatar.id})" 
                            class="avatar-card ${cardClass}" 
                            data-avatar-name="${avatar.name}">
                            ${contentHtml}
                            <span class="text-lg font-semibold mt-2 block">${avatar.name}</span>
                        </div>
                    `;
                });
                return html;
            }

            // --- TTS Logic ---
            function initTTS() {
                ttsSupported = !!(window.speechSynthesis);
                if (!ttsSupported) {
                    console.warn('TTS not supported in this browser');
                }
                
                // Check speech recognition support
                speechRecognitionSupported = !!(window.SpeechRecognition || window.webkitSpeechRecognition);
                if (!speechRecognitionSupported) {
                    console.warn('Speech recognition not supported in this browser');
                }
            }

            function speakInstruction(text) {
                if (!ttsEnabled || !ttsSupported) {
                    showGuide(text);
    
                    return;
                }

                const synth = window.speechSynthesis;

                // Cancel any ongoing speech
                if (synth.speaking) {
                    synth.cancel();
                }

                const utterance = new SpeechSynthesisUtterance(text);

                // Configure for Arabic
                utterance.lang = 'ar-SA';
                utterance.rate = 0.9;
                utterance.pitch = 1.1;

                // Show guide immediately
                showGuide(text);

                utterance.onend = () => {
                   
                };

                utterance.onerror = (event) => {
                    console.error('TTS Error:', event);
                    ttsSupported = false;
                   
                };

                try {
                    synth.speak(utterance);
                } catch (error) {
                    console.error('TTS Failed:', error);
                    ttsSupported = false;
                    
                }
            }

            function showGuide(text) {
                const guideElement = document.getElementById('batman-guide');
                const instructionText = document.getElementById('guide-instruction');
                if (guideElement && instructionText) {
                    instructionText.textContent = text;
                    guideElement.style.display = 'flex';
                }
            }

            function toggleTTS() {
                ttsEnabled = !ttsEnabled;
                const ttsButton = document.getElementById('tts-control');
                const icon = ttsButton.querySelector('i');

                if (ttsEnabled) {
                    ttsButton.classList.remove('muted');
                    icon.classList.remove('fa-volume-mute');
                    icon.classList.add('fa-volume-up');
                    speakInstruction('تم تفعيل الصوت');
                } else {
                    ttsButton.classList.add('muted');
                    icon.classList.remove('fa-volume-up');
                    icon.classList.add('fa-volume-mute');
                    if (window.speechSynthesis) {
                        window.speechSynthesis.cancel();
                    }
                    showGuide('تم إيقاف الصوت');
                }
            }

            // --- Audio Initialization ---
            function initializeAudioAndStart() {
                initTTS();

                if (audioInitialized) {
                    startApp();
                    return;
                }

                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        audioInitialized = true;
                        document.getElementById('audio-note').style.display = 'none';
                    
                        startApp();
                    }).catch(error => {
                        console.error('AudioContext failed:', error);
                        audioInitialized = true;
                        document.getElementById('audio-note').style.display = 'none';
                        startApp();
                    });
                } else {
                    audioInitialized = true;
                    document.getElementById('audio-note').style.display = 'none';
                
                    startApp();
                }
            }


            // --- Screen Navigation ---
            function showScreen(id) {
                document.querySelectorAll('.screen-container').forEach(screen => {
                    screen.classList.add('hidden');
                    screen.style.opacity = '0';
                    screen.style.transform = 'scale(0.95)';
                });

                const targetScreen = document.getElementById(id);
                if (targetScreen) {
                    targetScreen.classList.remove('hidden');
                    void targetScreen.offsetWidth;
                    targetScreen.style.opacity = '1';
                    targetScreen.style.transform = 'scale(1)';

                    const instruction = instructions[id] || 'مرحباً بك في شاشة جديدة!';

                    if (ttsEnabled && ttsSupported) {
                        speakInstruction(instruction);
                    } else {
                        showGuide(instruction);
                    }

                    if (id === 'avatar-screen') {
                        const avatarGrid = document.getElementById('avatar-grid');
                        if (avatarGrid) {
                            avatarGrid.innerHTML = generateAvatarGrid(userGender);
                            userAvatar = null;
                        }
                    }

                    if (id === 'checkin-screen') {
                        document.getElementById('checkin-prompt').innerText = `كيف تشعر اليوم يا ${userName || 'بطلنا'}؟`;
                        currentEmotion = null;
                        document.querySelectorAll('.emotion-button').forEach(btn => {
                            btn.classList.remove('ring-4', 'ring-pink-500', 'shadow-2xl');
                        });
                    }

                    if (id === 'main-menu') {
                        document.getElementById('menu-welcome').innerText = `أهلاً بك يا بطل ${userName || 'الخارق'}!`;
                    }
                }
            }

            // --- Name Recording Function (Fixed) ---
            function startNameRecording() {
                if (!speechRecognitionSupported) {
                    const message = "عذراً! الإدخال الصوتي غير متوفر في هذا المتصفح. استخدم لوحة المفاتيح.";
                    if (ttsEnabled && ttsSupported) {
                        speakInstruction(message);
                    } else {
                        showGuide(message);
                    }
                    return;
                }

                if (isRecordingName) {
                    stopNameRecording();
                    return;
                }

                try {
                    nameRecognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                    nameRecognition.lang = 'ar-SA';
                    nameRecognition.interimResults = false;
                    nameRecognition.maxAlternatives = 1;
                    nameRecognition.continuous = false;

                    const micButton = document.getElementById('name-record-button');
                    const micIcon = document.getElementById('name-record-icon');
                    
                    micButton.classList.add('bg-red-500', 'recording');
                    micIcon.classList.remove('fa-microphone');
                    micIcon.classList.add('fa-stop');
                    isRecordingName = true;
                    
                    if (ttsEnabled && ttsSupported) {
                        speakInstruction("تكلم الآن وقل اسمك بوضوح.");
                    } else {
                        showGuide("تكلم الآن وقل اسمك بوضوح.");
                    }
                    
                    nameRecognition.start();

                    nameRecognition.onresult = (event) => {
                        const nameResult = event.results[0][0].transcript;
                        document.getElementById('name-input').value = nameResult;
                        userName = nameResult;
                        stopNameRecording();
                        if (ttsEnabled && ttsSupported) {
                            speakInstruction(`أحسنت! اسمك هو ${nameResult}. اضغط على زر انطلق للمتابعة.`);
                        } else {
                            showGuide(`أحسنت! اسمك هو ${nameResult}. اضغط على زر انطلق للمتابعة.`);
                        }
                    };

                    nameRecognition.onerror = (event) => {
                        console.error('Name recording error:', event.error);
                        stopNameRecording();
                        
                        let errorMessage = "لم أستطع سماع اسمك بوضوح. حاول مرة أخرى!";
                        if (event.error === 'no-speech') {
                            errorMessage = "لم أسمع أي صوت. حاول التحدث بصوت أعلى.";
                        } else if (event.error === 'audio-capture') {
                            errorMessage = "لا يمكن الوصول إلى الميكروفون. تحقق من إعدادات الميكروفون.";
                        } else if (event.error === 'not-allowed') {
                            errorMessage = "لم يتم السماح باستخدام الميكروفون. يرجى منح الإذن.";
                        }
                        
                        if (ttsEnabled && ttsSupported) {
                            speakInstruction(errorMessage);
                        } else {
                            showGuide(errorMessage);
                        }
                    };

                    nameRecognition.onend = () => {
                        if (isRecordingName) {
                            stopNameRecording();
                            if (ttsEnabled && ttsSupported) {
                                speakInstruction("انتهى وقت التسجيل. حاول مرة أخرى إذا لم يكتب اسمك.");
                            } else {
                                showGuide("انتهى وقت التسجيل. حاول مرة أخرى إذا لم يكتب اسمك.");
                            }
                        }
                    };

                } catch (error) {
                    console.error('Failed to initialize speech recognition:', error);
                    speechRecognitionSupported = false;
                    const message = "عذراً! الإدخال الصوتي غير متوفر. استخدم لوحة المفاتيح.";
                    if (ttsEnabled && ttsSupported) {
                        speakInstruction(message);
                    } else {
                        showGuide(message);
                    }
                }
            }

            function stopNameRecording() {
                if (nameRecognition) {
                    try {
                        nameRecognition.stop();
                    } catch (e) {
                        console.log('Speech recognition already stopped');
                    }
                    nameRecognition = null;
                }
                
                const micButton = document.getElementById('name-record-button');
                const micIcon = document.getElementById('name-record-icon');
                
                if (micButton) {
                    micButton.classList.remove('bg-red-500', 'recording');
                }
                if (micIcon) {
                    micIcon.classList.remove('fa-stop');
                    micIcon.classList.add('fa-microphone');
                }
                isRecordingName = false;
            }

            // --- Voice Input for Other Fields ---
            function startVoiceInput(inputId) {
                if (!speechRecognitionSupported) {
                    const message = "عذراً! الإدخال الصوتي غير متوفر. استخدم لوحة المفاتيح.";
                    if (ttsEnabled && ttsSupported) {
                        speakInstruction(message);
                    } else {
                        showGuide(message);
                    }
                    return;
                }

                try {
                    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                    recognition.lang = 'ar-SA';
                    recognition.interimResults = false;
                    recognition.maxAlternatives = 1;
                    recognition.continuous = false;

                    const inputElement = document.getElementById(inputId);
                    const micIcon = document.getElementById(`mic-icon-${inputId}`);

                    if (micIcon) {
                        micIcon.classList.add('animate-pulse', 'text-red-600');
                    }

                    if (ttsEnabled && ttsSupported) {
                        speakInstruction("أستمع إليك! تكلم بوضوح الآن.");
                    } else {
                        showGuide("أستمع إليك! تكلم بوضوح الآن.");
                    }

                    recognition.start();

                    recognition.onresult = (event) => {
                        const speechResult = event.results[0][0].transcript;
                        if (inputElement) {
                            inputElement.value = speechResult;
                        }
                        if (micIcon) {
                            micIcon.classList.remove('animate-pulse', 'text-red-600');
                        }
                        if (ttsEnabled && ttsSupported) {
                            speakInstruction(`أحسنت! لقد كتبت: ${speechResult}`);
                        } else {
                            showGuide(`أحسنت! تم الكتابة: ${speechResult}`);
                        }
                    };

                    recognition.onerror = (event) => {
                        if (micIcon) {
                            micIcon.classList.remove('animate-pulse', 'text-red-600');
                        }
                        console.error('Speech recognition error:', event.error);
                        const errorMsg = "لم أستطع سماعك بوضوح. حاول مرة أخرى!";
                        if (ttsEnabled && ttsSupported) {
                            speakInstruction(errorMsg);
                        } else {
                            showGuide(errorMsg);
                         
                        }
                    };
                } catch (error) {
                    console.error('Failed to initialize speech recognition:', error);
                    speechRecognitionSupported = false;
                    const message = "عذراً! الإدخال الصوتي غير متوفر. استخدم لوحة المفاتيح.";
                    if (ttsEnabled && ttsSupported) {
                        speakInstruction(message);
                    } else {
                        showGuide(message);
                       
                    }
                }
            }

            // --- Screen Specific Logic ---
            function startApp() {
                const nameInput = document.getElementById('name-input');
                userName = nameInput ? nameInput.value.trim() : '';
                const gender = document.querySelector('input[name="gender"]:checked');

                if (!userName) {
                    const message = 'من فضلك أدخل اسمك أولاً يا بطل!';
                    if (ttsEnabled && ttsSupported) {
                        speakInstruction(message);
                    } else {
                        showGuide(message);
                    }
                    return;
                }
                if (!gender) {
                    const message = 'من فضلك اختر الجنس (ولد أو بنت) لتحديد شخصيتك!';
                    if (ttsEnabled && ttsSupported) {
                        speakInstruction(message);
                    } else {
                        showGuide(message);
                    }
                    return;
                }
                userGender = gender.value;
                showScreen('avatar-screen');
            }

            function selectAvatar(avatarId) {
                userAvatar = avatarId;
                document.querySelectorAll('.avatar-card').forEach(card => {
                    card.classList.remove('ring-4', 'ring-yellow-500', 'scale-110');
                });
                const selectedCard = document.getElementById(`avatar-${avatarId}`);
                if (selectedCard) {
                    selectedCard.classList.add('ring-4', 'ring-yellow-500', 'scale-110');
                }

                const message = 'أحسنت الاختيار! هذا البطل سيكون صديقك في المغامرة.';
                if (ttsEnabled && ttsSupported) {
                    speakInstruction(message);
                } else {
                    showGuide(message);
                }
            }

            function confirmAvatar() {
                if (!userAvatar) {
                    const message = 'من فضلك اختر شخصية لتمثلك يا بطل!';
                    if (ttsEnabled && ttsSupported) {
                        speakInstruction(message);
                    } else {
                        showGuide(message);
                    }
                    return;
                }
                showScreen('checkin-screen');
            }

            function selectEmotion(emotion, audioPrompt, button) {
                currentEmotion = emotion;
                document.querySelectorAll('.emotion-button').forEach(btn => {
                    btn.classList.remove('ring-4', 'ring-pink-500', 'shadow-2xl');
                });
                if (button) {
                    button.classList.add('ring-4', 'ring-pink-500', 'shadow-2xl');
                }

                const message = `أحسنت! لقد اخترت شعور ${audioPrompt}. الآن اضغط على زر "اكمل المغامرة" في الأسفل.`;
                if (ttsEnabled && ttsSupported) {
                    speakInstruction(message);
                } else {
                    showGuide(message);
                }
            }

            function recordAndNavigate() {
                if (!currentEmotion) {
                    const message = 'من فضلك اختر شعوراً أولاً لتسجل إنجازك اليومي!';
                    if (ttsEnabled && ttsSupported) {
                        speakInstruction(message);
                    } else {
                        showGuide(message);
                    }
                    return;
                }
                const message = `سجلنا شعورك! استعد للمغامرة في القائمة الرئيسية.`;
                if (ttsEnabled && ttsSupported) {
                    speakInstruction(message);
                } else {
                    showGuide(message);
                    
                }
                showScreen('main-menu');
            }

            function startLevel(level, levelName) {
                const message = `تبدأ الآن المستوى ${level}. تعلم عن ${levelName}، ثم سنذهب إلى تحدي الكاميرا!`;
                if (ttsEnabled && ttsSupported) {
                    speakInstruction(message);
                } else {
                    showGuide(message);
                   
                }
                showScreen('learning-screen');
            }

            // --- Initialization ---
            document.addEventListener('DOMContentLoaded', () => {
                initTTS();

                const ttsControl = document.getElementById('tts-control');
                if (ttsControl) {
                    ttsControl.addEventListener('click', toggleTTS);
                }

                showScreen('welcome-screen');

                if (!audioInitialized) {
                    const audioNote = document.getElementById('audio-note');
                    if (audioNote) {
                        audioNote.style.display = 'block';
                    }
                }

                showGuide('مرحباً بك في عالم المشاعر! أدخل اسمك واختر جنسك ثم انقر على انطلق!');
               
            });
        </script>

        <!-- Rest of HTML remains the same -->
        <div id="welcome-screen" class="screen-container bg-white p-6 rounded-3xl shadow-2xl space-y-8">
            <h1 class="text-4xl font-extrabold text-pink-600 text-center mt-4">مرحباً بك في عالم المشاعر!</h1>

            <div class="flex justify-center">
                <span class="text-[8rem] block animate-pulse">🌟</span>
            </div>

            <div class="space-y-3">
                <label for="name-input" class="block text-xl font-bold text-teal-600 text-center">ما هو اسمك الجميل؟</label>
                <div class="flex items-center space-x-2 space-x-reverse">
                    <input type="text" id="name-input" placeholder="اكتب اسمك هنا"
                        class="flex-grow p-4 border-4 border-pink-300 rounded-xl focus:border-teal-500 text-lg text-center transition duration-300">
                    <button id="name-record-button" onclick="startNameRecording()"
                        class="p-3 bg-blue-500 text-white rounded-xl shadow-lg hover:bg-blue-600 flex items-center justify-center">
                        <i id="name-record-icon" class="fas fa-microphone text-2xl"></i>
                    </button>
                </div>
            </div>

            <div class="space-y-4">
                <p class="text-xl font-bold text-teal-600 text-center">أنا:</p>
                <div class="flex justify-around gap-4">
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="gender" value="boy" class="hidden peer">
                        <div
                            class="bg-blue-200 p-4 rounded-xl text-center shadow-lg peer-checked:bg-blue-500 peer-checked:text-white border-4 border-blue-500 peer-checked:border-blue-700 transition duration-300 transform hover:scale-105">
                            <span class="text-5xl">🧑🏻</span>
                            <span class="block text-lg font-semibold mt-1">ولد</span>
                        </div>
                    </label>
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="gender" value="girl" class="hidden peer">
                        <div
                            class="bg-pink-200 p-4 rounded-xl text-center shadow-lg peer-checked:bg-pink-500 peer-checked:text-white border-4 border-pink-500 peer-checked:border-pink-700 transition duration-300 transform hover:scale-105">
                            <span class="text-5xl">👸🏻</span>
                            <span class="block text-lg font-semibold mt-1">بنت</span>
                        </div>
                    </label>
                </div>
            </div>

            <button id="start-button" onclick="initializeAudioAndStart()"
                class="w-full bg-pink-500 text-white p-4 rounded-full text-2xl font-bold shadow-xl hover:bg-pink-600 transform hover:scale-105 transition duration-300">
                انطلق!
            </button>
            <p id="audio-note" class="text-sm text-center text-red-500 mt-2 font-semibold" style="display:none;">(اضغط للبدء والسماح بتشغيل الصوت والموسيقى)</p>
        </div>

        <!-- Rest of your screens remain the same -->
        <div id="avatar-screen" class="screen-container hidden bg-white p-6 rounded-3xl shadow-2xl space-y-8">
            <h2 class="text-3xl font-extrabold text-teal-600 text-center mt-4">اختر بطلك الخارق!</h2>

            <div id="avatar-grid" class="grid grid-cols-3 gap-4"></div>

            <button onclick="confirmAvatar()"
                class="w-full bg-teal-500 text-white p-4 rounded-full text-2xl font-bold shadow-xl hover:bg-teal-600 transform hover:scale-105 transition duration-300 mt-6">
                هذه شخصيتي!
            </button>
        </div>

        <div id="checkin-screen" class="screen-container hidden bg-white p-6 rounded-3xl shadow-2xl space-y-8">
            <div class="text-center bg-yellow-100 p-4 rounded-2xl border-4 border-yellow-300">
                <h2 id="checkin-prompt" class="text-3xl font-extrabold text-gray-800">كيف تشعر اليوم يا بطل؟</h2>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <button onclick="selectEmotion('happy', 'السعادة', this)"
                    class="emotion-button bg-green-200 p-4 rounded-2xl hover:bg-green-300 transform hover:scale-105">
                    <span class="text-6xl block animate-bounce">😊</span>
                    <span class="text-lg font-bold mt-1 text-green-800">سعيد</span>
                </button>
                <button onclick="selectEmotion('sad', 'الحزن', this)"
                    class="emotion-button bg-blue-200 p-4 rounded-2xl hover:bg-blue-300 transform hover:scale-105">
                    <span class="text-6xl block">😟</span>
                    <span class="text-lg font-bold mt-1 text-blue-800">حزين</span>
                </button>
                <button onclick="selectEmotion('angry', 'الغضب', this)"
                    class="emotion-button bg-red-200 p-4 rounded-2xl hover:bg-red-300 transform hover:scale-105">
                    <span class="text-6xl block animate-shake">😡</span>
                    <span class="text-lg font-bold mt-1 text-red-800">غاضب</span>
                </button>
                <button onclick="selectEmotion('scared', 'الخوف', this)"
                    class="emotion-button bg-purple-200 p-4 rounded-2xl hover:bg-purple-300 transform hover:scale-105">
                    <span class="text-6xl block">😨</span>
                    <span class="text-lg font-bold mt-1 text-purple-800">خائف</span>
                </button>
                <button onclick="selectEmotion('surprised', 'الدهشة', this)"
                    class="emotion-button bg-yellow-200 p-4 rounded-2xl hover:bg-yellow-300 transform hover:scale-105">
                    <span class="text-6xl block">😲</span>
                    <span class="text-lg font-bold mt-1 text-yellow-800">متفاجئ</span>
                </button>
                <button onclick="selectEmotion('tired', 'التعب', this)"
                    class="emotion-button bg-gray-200 p-4 rounded-2xl hover:bg-gray-300 transform hover:scale-105">
                    <span class="text-6xl block">😴</span>
                    <span class="text-lg font-bold mt-1 text-gray-800">متعب</span>
                </button>
            </div>

            <button onclick="recordAndNavigate()"
                class="w-full bg-pink-500 text-white p-4 rounded-full text-2xl font-bold shadow-xl hover:bg-pink-600 transform hover:scale-105 transition duration-300 mt-6">
                اكمل المغامرة!
            </button>
        </div>

        <!-- Rest of your screens remain the same -->
        <div id="main-menu" class="screen-container hidden bg-white p-6 rounded-3xl shadow-2xl space-y-6">
            <h2 id="menu-welcome" class="text-3xl font-extrabold text-teal-600 text-center mt-4">أهلاً بك يا بطل!</h2>

            <div
                class="flex justify-between items-center bg-purple-100 p-3 rounded-xl shadow-inner border-2 border-purple-300">
                <div class="flex items-center space-x-2 space-x-reverse">
                    <span class="text-3xl text-red-500">🏆</span>
                    <span class="text-lg font-bold text-gray-700">النقاط: 45 نجمة</span>
                </div>
                <button onclick="showScreen('leaderboard-screen')"
                    class="flex items-center space-x-1 space-x-reverse text-purple-600 font-bold p-2 bg-purple-200 rounded-lg hover:bg-purple-300 transform hover:scale-105">
                    <i class="fas fa-chart-bar"></i>
                    <span>لوحة الأبطال</span>
                </button>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="startLevel(1, 'المشاعر الأساسية')"
                    class="bg-green-500 text-white p-6 rounded-2xl shadow-xl transform hover:scale-105 transition duration-300 space-y-2 border-4 border-green-700">
                    <span class="text-5xl block">😊😠😨</span>
                    <span class="text-xl font-bold">المستوى الأول</span>
                </button>

                <button onclick="startLevel(2, 'المشاعر المختلطة')"
                    class="bg-blue-500 text-white p-6 rounded-2xl shadow-xl transform hover:scale-105 transition duration-300 space-y-2 border-4 border-blue-700">
                    <span class="text-5xl block">🤯😵‍💫</span>
                    <span class="text-xl font-bold">المستوى الثاني</span>
                </button>

                <div
                    class="bg-gray-300 text-gray-600 p-6 rounded-2xl shadow-inner space-y-2 opacity-80 border-4 border-gray-400">
                    <span class="text-5xl block">🔒</span>
                    <span class="text-xl font-bold">المستوى الثالث</span>
                </div>

                <button onclick="showScreen('checkin-screen')"
                    class="bg-yellow-500 text-gray-800 p-6 rounded-2xl shadow-xl hover:bg-yellow-600 transform hover:scale-105 transition duration-300 border-4 border-yellow-700">
                    <span class="text-5xl block">🗓️</span>
                    <span class="text-xl font-bold">فحص اليوم</span>
                </button>
            </div>
        </div>

        <div id="learning-screen" class="screen-container hidden bg-white p-6 rounded-3xl shadow-2xl space-y-6">
            <h2
                class="text-3xl font-extrabold text-green-600 text-center mt-4 bg-green-100 p-3 rounded-xl border-4 border-green-300">
                شعور: السعادة (Happiness)</h2>

            <div
                class="aspect-video bg-green-200 rounded-3xl flex items-center justify-center shadow-lg border-4 border-green-500">
                <p class="text-2xl text-green-800 font-bold p-4">مكان عرض فيديو كرتوني عن السعادة</p>
            </div>

            <div class="flex items-center justify-center">
                <button onclick="speakInstruction('السعادة تجعلك تحب اللعب والضحك! اشعر بها في قلبك!')"
                    class="w-40 h-40 bg-white rounded-full shadow-2xl flex items-center justify-center border-8 border-yellow-500 transform hover:scale-110 transition duration-300">
                    <span class="text-[5rem] animate-pulse">😁</span>
                </button>
            </div>
            <p class="text-center text-lg text-gray-700">اضغط على الوجه لتسمع عنه!</p>

            <div class="flex justify-between gap-4">
                <button onclick="showScreen('main-menu')"
                    class="flex-1 bg-gray-400 text-white p-4 rounded-full text-lg font-bold shadow-xl hover:bg-gray-500 transform hover:scale-105 transition duration-300">
                    <i class="fas fa-home"></i>
                    <span>العودة للقائمة</span>
                </button>
                <button onclick="showScreen('face-detection-screen')"
                    class="flex-1 bg-pink-500 text-white p-4 rounded-full text-lg font-bold shadow-xl hover:bg-pink-600 transform hover:scale-105 transition duration-300">
                    <span>التالي: تحدي الكاميرا</span>
                    <i class="fas fa-arrow-left mr-2"></i>
                </button>
            </div>
        </div>

        <div id="face-detection-screen" class="screen-container hidden bg-white p-6 rounded-3xl shadow-2xl space-y-6">
            <h2
                class="text-3xl font-extrabold text-blue-600 text-center mt-4 bg-blue-100 p-3 rounded-xl border-4 border-blue-300">
                تحدي تعابير الوجه</h2>

            <p
                class="text-xl text-center text-gray-700 font-semibold p-2 bg-blue-50 rounded-lg border-2 border-blue-200">
                وجهك بطل! الآن حاول أن تعبر عن شعور: <span class="text-pink-600 font-extrabold text-2xl">😊 السعادة 😊</span>
            </p>

            <div
                class="w-full aspect-square bg-gray-200 rounded-3xl border-4 border-dashed border-blue-400 flex flex-col items-center justify-center shadow-inner">
                <i class="fas fa-camera text-blue-500 text-6xl"></i>
                <p class="mt-2 text-blue-500 font-semibold">منطقة الكاميرا تنتظر وجهك المبتسم</p>
            </div>

            <div id="feedback-area" class="bg-green-100 p-4 rounded-xl text-center border-4 border-green-400">
                <p class="text-xl font-bold text-green-800">جاري الكشف... ابتسم يا بطل!</p>
            </div>

            <button onclick="showScreen('challenge-screen')"
                class="w-full bg-teal-500 text-white p-4 rounded-full text-2xl font-bold shadow-xl hover:bg-teal-600 transform hover:scale-105 transition duration-300">
                انتقل إلى الاختبار
            </button>
        </div>

        <div id="challenge-screen" class="screen-container hidden bg-white p-6 rounded-3xl shadow-2xl space-y-6">
            <h2
                class="text-3xl font-extrabold text-pink-600 text-center mt-4 bg-pink-100 p-3 rounded-xl border-4 border-pink-300">
                تحدي اليوم!</h2>

            <div class="bg-purple-50 p-4 rounded-xl border-2 border-purple-300 space-y-3">
                <p class="text-lg font-bold text-purple-800 text-center">السؤال (1/5):</p>
                <p class="text-xl text-gray-800 font-semibold text-center">تخيل أن صديقك كسر لعبتك المفضلة. ما هو الشعور الأقرب إليك؟</p>
                <div class="grid grid-cols-2 gap-3">
                    <button
                        class="p-3 bg-red-200 rounded-xl text-2xl font-bold hover:bg-red-300 transform hover:scale-105 transition duration-200">غضب 😡</button>
                    <button
                        class="p-3 bg-blue-200 rounded-xl text-2xl font-bold hover:bg-blue-300 transform hover:scale-105 transition duration-200">حزن 😟</button>
                    <button
                        class="p-3 bg-green-200 rounded-xl text-2xl font-bold hover:bg-green-300 transform hover:scale-105 transition duration-200">سعادة 😊</button>
                    <button
                        class="p-3 bg-yellow-200 rounded-xl text-2xl font-bold hover:bg-yellow-300 transform hover:scale-105 transition duration-200">خوف 😨</button>
                </div>
            </div>

            <hr class="border-t-2 border-dashed border-gray-300">

            <div class="space-y-3">
                <h3 class="text-2xl font-bold text-teal-600 text-center">أخبرنا عن يومك!</h3>
                <div class="flex items-center space-x-2 space-x-reverse">
                    <textarea id="reflection-input" placeholder="مثال: شعرت بالبهجة عندما..."
                        class="flex-grow p-3 border-4 border-teal-300 rounded-xl h-24 focus:border-teal-500 text-base"></textarea>
                    <button onclick="startVoiceInput('reflection-input')"
                        class="self-start mt-1 p-3 bg-blue-500 text-white rounded-xl shadow-lg hover:bg-blue-600 flex items-center justify-center">
                        <i id="mic-icon-reflection-input" class="fas fa-microphone text-2xl"></i>
                    </button>
                </div>
            </div>

            <button onclick="showScreen('main-menu')"
                class="w-full bg-pink-500 text-white p-4 rounded-full text-2xl font-bold shadow-xl hover:bg-pink-600 transform hover:scale-105 transition duration-300 mt-4">
                أكملت التحدي!
            </button>
        </div>

        <div id="leaderboard-screen" class="screen-container hidden bg-white p-6 rounded-3xl shadow-2xl space-y-6">
            <h2
                class="text-3xl font-extrabold text-yellow-600 text-center mt-4 bg-yellow-100 p-3 rounded-xl border-4 border-yellow-300">
                لوحة أبطال المشاعر</h2>

            <div class="bg-white p-4 rounded-xl border-4 border-teal-400 shadow-xl space-y-2">
                <h3 class="text-2xl font-bold text-teal-600 text-center">ملفك الشخصي</h3>
                <div class="flex justify-around text-center">
                    <div>
                        <span class="text-5xl font-extrabold text-pink-500 block">3</span>
                        <span class="text-sm text-gray-600">مستويات</span>
                    </div>
                    <div>
                        <span class="text-5xl font-extrabold text-pink-500 block">45</span>
                        <span class="text-sm text-gray-600">نجمة</span>
                    </div>
                    <div>
                        <span class="text-5xl font-extrabold text-pink-500 block">🔥3</span>
                        <span class="text-sm text-gray-600">أيام سلسلة</span>
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl border-2 border-gray-200">
                <h3 class="text-2xl font-bold text-gray-800 mb-3 text-center">🏆 الأبطال المتصدرون</h3>
                <ul class="space-y-3">
                    <li
                        class="flex justify-between items-center p-3 bg-yellow-100 rounded-lg shadow-md border-r-8 border-yellow-500 transform hover:scale-[1.02] transition duration-200">
                        <div class="flex items-center space-x-3 space-x-reverse">
                            <span class="text-2xl font-extrabold text-yellow-700">1</span>
                            <span class="text-3xl">🥇</span>
                            <span class="text-lg font-bold text-gray-800">البطل أحمد</span>
                        </div>
                        <span class="text-xl font-bold text-yellow-700">52 نجمة</span>
                    </li>
                    <li
                        class="flex justify-between items-center p-3 bg-gray-100 rounded-lg border-r-4 border-gray-400 transform hover:scale-[1.02] transition duration-200">
                        <div class="flex items-center space-x-3 space-x-reverse">
                            <span class="text-2xl font-extrabold text-gray-700">2</span>
                            <span class="text-3xl">🥈</span>
                            <span class="text-lg font-bold text-gray-800">البطلة سارة</span>
                        </div>
                        <span class="text-xl font-bold text-gray-700">48 نجمة</span>
                    </li>
                    <li
                        class="flex justify-between items-center p-3 bg-pink-50 rounded-lg border-r-4 border-pink-500 font-bold transform hover:scale-[1.02] transition duration-200">
                        <div class="flex items-center space-x-3 space-x-reverse">
                            <span class="text-2xl font-extrabold text-pink-600">4</span>
                            <span class="text-lg text-pink-600">أنت!</span>
                        </div>
                        <span class="text-xl font-bold text-pink-600">45 نجمة</span>
                    </li>
                </ul>
            </div>

            <button onclick="showScreen('main-menu')"
                class="w-full bg-teal-500 text-white p-4 rounded-full text-2xl font-bold shadow-xl hover:bg-teal-600 transform hover:scale-105 transition duration-300 mt-4">
                العودة للقائمة
            </button>
        </div>
    </div>
</body>
</html>
